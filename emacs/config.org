#+TITLE: B2F's GNU Emacs Config
#+AUTHOR: Andrey Akimov (Brown2Fox)
#+DESCRIPTION: B2F's personal Emacs config.
#+STARTUP: showeverything
#+OPTIONS: toc:2

* TABLE OF CONTENTS :toc:
- [[#auto-gen-comment][Auto Gen Comment]]
- [[#straight-package-manager][Straight Package Manager]]
  - [[#bootstrap][Bootstrap]]
  - [[#config][Config]]
- [[#custom-straight-recipes][Custom Straight Recipes]]
- [[#evil-mode][Evil Mode]]
- [[#general-keybindings][General Keybindings]]
- [[#buffer-move][Buffer Move]]
- [[#completion][Completion]]
  - [[#ivy--counsel][Ivy + Counsel]]
- [[#dashboard][Dashboard]]
- [[#dired][Dired]]
- [[#language-support][Language Support]]
- [[#org-mode][Org Mode]]
  - [[#enabling-table-of-contents][Enabling Table of Contents]]
  - [[#enabling-org-bullets][Enabling Org Bullets]]
  - [[#disable-electric-indent][Disable Electric Indent]]
  - [[#shift-select][Shift Select]]
  - [[#org-level-headers][Org Level Headers]]
  - [[#source-code-block-tag-expansion][Source Code Block Tag Expansion]]
- [[#projectile][Projectile]]
- [[#visuals][Visuals]]
  - [[#smooth-scrolling][Smooth Scrolling]]
  - [[#beacon-mode][Beacon Mode]]
  - [[#fonts][Fonts]]
  - [[#icons][Icons]]
  - [[#mode-line][Mode Line]]
  - [[#rainbow-mode][Rainbow Mode]]
  - [[#theme][Theme]]
- [[#which-key][Which Key]]
- [[#uncategorized][Uncategorized]]

* Auto Gen Comment

#+begin_src emacs-lisp
;; This file is auto-generated from config.org
#+end_src

* Straight Package Manager

** Bootstrap

Can be moved outside.

#+begin_src emacs-lisp
(defvar bootstrap-version)
(let ((bootstrap-file
       (expand-file-name
        "straight/repos/straight.el/bootstrap.el"
        (or (bound-and-true-p straight-base-dir)
            user-emacs-directory)))
      (bootstrap-version 7))
  (unless (file-exists-p bootstrap-file)
    (with-current-buffer
        (url-retrieve-synchronously
         "https://raw.githubusercontent.com/radian-software/straight.el/develop/install.el"
         'silent 'inhibit-cookies)
      (goto-char (point-max))
      (eval-print-last-sexp)))
  (load bootstrap-file nil 'nomessage))
#+end_src

** Config

#+begin_src emacs-lisp
(straight-use-package 'use-package)
(setq straight-use-package-by-default t)
#+end_src

* Custom Straight Recipes

#+begin_src emacs-lisp
(straight-use-package '(nerd-icons-ivy-rich :type git :host github :repo "seagle0128/nerd-icons-ivy-rich"))
(straight-use-package '(beacon :type git :host github :repo "Malabarba/beacon"))
#+end_src

* Evil Mode

#+begin_src emacs-lisp
(use-package evil
  :init      ;; tweak evil's configuration before loading it
  (setq evil-want-integration nil)
  (setq evil-want-keybinding nil)
  (setq evil-vsplit-window-right t)
  (setq evil-split-window-below t))
;; (use-package evil-collection
;;   :straight t
;;   :after evil
;;   :config
;;   (setq evil-collection-mode-list '(dashboard dired ibuffer))
;;   (evil-collection-init))
;; (use-package evil-tutor
;;   :straight t)
#+end_src

* General Keybindings

#+begin_src emacs-lisp 
(use-package general
  :config

  (general-unbind "M-h" "M-j" "M-k" "M-l")
  (general-unbind org-mode-map "M-h")

  (general-define-key
   "M-h" 'left-char
   "M-j" 'evil-next-line
   "M-k" 'evil-previous-line
   "M-l" 'right-char)

  (defconst b2f-leader-key "<f24>")
  ;; set up 'F24' (omg) as the global leader key
  (general-create-definer leader-keys
    :prefix "<f24>") ;; set leader
                                        ;:global-prefix "M-<f24>" ;; access leader in insert mode

  (leader-keys
    "<f24>"   '(counsel-M-x                                                        :wk "Counsel M-x")
    "."       '(find-file                                                          :wk "Find file")
    "f c"     '((lambda () (interactive) (find-file "~/.config/emacs/config.org")) :wk "Edit emacs config")
    "f r"     '(counsel-recentf                                                    :wk "Find recent files")
    "TAB TAB" '(comment-line                                                       :wk "Comment lines"))

  (leader-keys
    "b"   '(:ignore t          :wk "Buffer")
    "b b" '(switch-to-buffer   :wk "Switch buffer")
    "b i" '(ibuffer            :wk "Ibuffer")
    "b k" '(kill-this-buffer   :wk "Kill this buffer")
    "b o" '(kill-other-buffers :wk "Kill other buffers")
    "b n" '(next-buffer        :wk "Next buffer")
    "b p" '(previous-buffer    :wk "Previous buffer")
    "b r" '(revert-buffer      :wk "Reload buffer")
    "b s" '(save-buffer        :wk "Save buffer"))

  (leader-keys
    "d"   '(:ignore t :wk "Dired")
    "d d" '(dired :wk "Open dired")
    "d j" '(dired-jump :wk "Dired jump to current")
    "d c" '(:ignore t :wk "Create")
    "d c f" '(dired-create-empty-file :wk "Empty file")
    "d c d" '(dired-create-directory :wk "Directory")
)
    ;; "d n" '(neotree-dir :wk "Open directory in neotree")
    ;; "d p" '(peep-dired :wk "Peep-dired"))

  (leader-keys
    "e"   '(:ignore t           :wk "Evaluate")
    "e b" '(eval-buffer         :wk "Evaluate elisp in buffer")
    "e d" '(eval-defun          :wk "Evaluate defun containing or after point")
    "e e" '(eval-expression     :wk "Evaluate and elisp expression")
    "e h" '(counsel-esh-history :wk "Eshell history")
    "e l" '(eval-last-sexp      :wk "Evaluate elisp expression before point")
    "e r" '(eval-region         :wk "Evaluate elisp in region")
    "e s" '(eshell              :wk "Eshell"))

  (leader-keys
    "h"     '(:ignore t                                                       :wk "Help")
    "h f"   '(describe-function                                               :wk "Describe function")
    "h v"   '(describe-variable                                               :wk "Describe variable")
    "h s"   '(describe-symbol                                                 :wk "Describe symbol")
    "h b"   '(describe-bindings                                               :wk "Describe bindings")
    "h k"   '(describe-key                                                    :wk "Describe key")
    "h r r" '((lambda () (interactive) (load-file "~/.config/emacs/init.el")) :wk "Reload emacs config"))
  ;;"h r r" '(reload-init-file :wk "Reload emacs config"))

  (leader-keys
    "m"   '(:ignore t           :wk "Org")
    "m a" '(org-agenda          :wk "Org agenda")
    "m e" '(org-export-dispatch :wk "Org export dispatch")
    "m i" '(org-toggle-item     :wk "Org toggle item")
    "m t" '(org-todo            :wk "Org todo")
    "m B" '(org-babel-tangle    :wk "Org babel tangle")
    "m T" '(org-todo-list       :wk "Org todo list"))

  (leader-keys
    "m b"   '(:ignore t              :wk "Tables")
    "m b -" '(org-table-insert-hline :wk "Insert hline in table"))

  (leader-keys
    "m d"   '(:ignore t      :wk "Date/deadline")
    "m d t" '(org-time-stamp :wk "Org time stamp"))

  (leader-keys
    "p" '(projectile-command-map :wk "Projectile"))

  (leader-keys
    "o"   '(:ignore t      :wk "Open")
    "o d" '(dashboard-open :wk "Open Dashboard"))

  (leader-keys
    "t"   '(:ignore t                 :wk "Toggle")
    "t l" '(display-line-numbers-mode :wk "Toggle line numbers")
    "t t" '(visual-line-mode          :wk "Toggle truncated lines"))

  (leader-keys
    "w"   '(:ignore t            :wk "Windows")
    ;; Window splits
    "w c" '(evil-window-delete   :wk "Close window")
    "w o" '(delete-other-windows :wk "Close other windows")
    "w n" '(evil-window-new      :wk "New window")
    "w s" '(evil-window-split    :wk "Horizontal split window")
    "w v" '(evil-window-vsplit   :wk "Vertical split window")
    ;; Window motions
    "w h" '(evil-window-left     :wk "Window left")
    "w j" '(evil-window-down     :wk "Window down")
    "w k" '(evil-window-up       :wk "Window up")
    "w l" '(evil-window-right    :wk "Window right")
    "w w" '(evil-window-next     :wk "Goto next window")
    ;; Move Windows
    "w H" '(buf-move-left        :wk "Buffer move left")
    "w J" '(buf-move-down        :wk "Buffer move down")
    "w K" '(buf-move-up          :wk "Buffer move up")
    "w L" '(buf-move-right       :wk "Buffer move right"))
  )
#+end_src

* Buffer Move

#+begin_src emacs-lisp
(use-package buffer-move)
#+end_src

* Completion

** Ivy + Counsel

#+begin_src emacs-lisp
(use-package ivy
  :bind
  ;; ivy-resume resumes the last Ivy-based completion.
  (("C-c C-r" . ivy-resume)
   ("C-x B" . ivy-switch-buffer-other-window))
  :custom
  (setq ivy-use-virtual-buffers t)
  (setq ivy-count-format "(%d/%d) ")
  (setq enable-recursive-minibuffers t)
  :config (ivy-mode 1))

(use-package counsel
  ;; :after ivy
  :config (counsel-mode 1))

(use-package ivy-rich
  ;; :after counsel
  :init (setq ivy-rich-path-style 'abbrev
              ivy-virtual-abbreviate 'full)
  :config (ivy-rich-mode 1))

(use-package nerd-icons-ivy-rich
  ;; :after ivy-rich
  :config (nerd-icons-ivy-rich-mode 1))
#+end_src

* Dashboard

#+begin_src emacs-lisp
(use-package dashboard
  :init
  (setq initial-buffer-choice 'dashboard-open)
  (setq dashboard-set-heading-icons t)
  (setq dashboard-set-file-icons t)
  (setq dashboard-startup-banner 'logo)
  (setq dashboard-center-content nil) ;; set to 't' for centered content
  (setq dashboard-vertically-center-content nil) ;; set to 't' for centered content vertically
  (setq dashboard-items '((recents   . 5)
                        (bookmarks . 5)
                        (projects  . 5)
                        (agenda    . 5)
                        (registers . 5)))
  (setq dashboard-display-icons-p t)     ; display icons on both GUI and terminal
  (setq dashboard-icon-type 'nerd-icons) ; use `nerd-icons' package
  (setq dashboard-projects-backend 'projectile)
  :config
  (dashboard-setup-startup-hook))
#+end_src

* Dired

#+begin_src emacs-lisp
(defun dired-move-item-up ()
  "Move dired item down in buffer."
  (interactive)
  (unless (dired-get-filename nil t)
    (error "Not a dired draggable item"))
  (when (= (line-number-at-pos) 2)
    (error "Already at top"))
  (let* ((inhibit-read-only t)
         (col (current-column))
         (item-start (line-beginning-position))
         (item-end (1+ (line-end-position)))
         (item (buffer-substring item-start item-end)))
    (delete-region item-start item-end)
    (forward-line -1)
    (beginning-of-line)
    (insert item)
    (forward-line -1)
    (move-to-column col)))

(defun dired-move-item-down ()
  "Move dired item down in buffer."
  (interactive)
  (unless (dired-get-filename nil t)
    (error "Not a dired draggable item"))
  (when (save-excursion
          (forward-line 1)
          (eobp))
    (error "Already at bottom"))
  (let* ((inhibit-read-only t)
         (col (current-column))
         (item-start (line-beginning-position))
         (item-end (1+ (line-end-position)))
         (item (buffer-substring item-start item-end)))
    (delete-region item-start item-end)
    (forward-line 1)
    (beginning-of-line)
    (insert item)
    (forward-line -1)
    (move-to-column col)))

(defun dired-from-marked-items ()
  "Create a new dired buffer containing only the marked files.
  Also allow dragging items up and down via M-<up> and M-x<down>."
  (interactive)
  (let ((marked-files (dired-get-marked-files))
        (buffer-name (generate-new-buffer-name
                      (format "*%s (selection)*"
                              (file-name-nondirectory
                               (directory-file-name default-directory))))))
    (unless marked-files
          (error "No dired marked files"))
        (dired (cons buffer-name
                     (mapcar (lambda (path)
                               (file-relative-name path default-directory))
                             marked-files)))))

(setq dired-listing-switches "-avlD --group-directories-first --human-readable")
(setq dired-omit-files "\\|^\\..+$")
(setq-default dired-dwim-target t)
(setq dired-mouse-drag-files t)

(use-package nerd-icons-dired
    :after nerd-icons
    :hook (dired-mode . nerd-icons-dired-mode))
#+end_src

* Language Support
Emacs has built-in programming language modes for Lisp, Scheme, DSSSL, Ada, ASM, AWK, C, C++, Fortran, Icon, IDL (CORBA), IDLWAVE, Java, Javascript, M4, Makefiles, Metafont, Modula2, Object Pascal, Objective-C, Octave, Pascal, Perl, Pike, PostScript, Prolog, Python, Ruby, Simula, SQL, Tcl, Verilog, and VHDL.  Other languages will require you to install additional modes.

#+begin_src emacs-lisp
(use-package haskell-mode)
(use-package lua-mode)
#+end_src

* Org Mode

** Enabling Table of Contents
#+begin_src emacs-lisp
(use-package toc-org
    :commands toc-org-enable
    :init (add-hook 'org-mode-hook 'toc-org-enable))
#+end_src

** Enabling Org Bullets
Org-bullets gives us attractive bullets rather than asterisks.

#+begin_src emacs-lisp
(use-package org-superstar
  :config
  (setq org-superstar-leading-bullet " ")
  ;; (setq org-superstar-headline-bullets-list '("◉" "○" "⚬" "◈" "◇"))
  (setq org-superstar-special-todo-items t) ;; Makes TODO header bullets into boxes
  (setq org-superstar-todo-bullet-alist '(("TODO"  . 9744)
                                          ("WAIT"  . 9744)
                                          ("READ"  . 9744)
                                          ("PROG"  . 9744)
										  ("DONE"  . 9745)))
  :hook (org-mode . org-superstar-mode))
#+end_src

** Disable Electric Indent
Org mode source blocks have some really weird and annoying default indentation behavior.  I think this has to do with electric-indent-mode, which is turned on by default in Emacs.  So let's turn it OFF!

#+begin_src emacs-lisp
(electric-indent-mode -1)
(setq org-edit-src-content-indentation 0)
#+end_src

** Shift Select

#+begin_src emacs-lisp
(setq org-support-shift-select 'always)
#+end_src

** Org Level Headers

#+begin_src emacs-lisp
(custom-set-faces
 '(org-level-1 ((t (:inherit outline-1 :height 1.7))))
 '(org-level-2 ((t (:inherit outline-2 :height 1.6))))
 '(org-level-3 ((t (:inherit outline-3 :height 1.5))))
 ;; '(org-level-4 ((t (:inherit outline-4 :height 1.4))))
 '(org-level-5 ((t (:inherit outline-5 :height 1.3))))
 '(org-level-6 ((t (:inherit outline-5 :height 1.2))))
 '(org-level-7 ((t (:inherit outline-5 :height 1.1)))))
#+end_src

** Source Code Block Tag Expansion
Org-tempo is not a separate package but a module within org that can be enabled.  Org-tempo allows for '<s' followed by TAB to expand to a begin_src tag.  Other expansions available include:

| Typing the below + TAB | Expands to ...                          |
|------------------------+-----------------------------------------|
| <a                     | '#+BEGIN_EXPORT ascii' … '#+END_EXPORT  |
| <c                     | '#+BEGIN_CENTER' … '#+END_CENTER'       |
| <C                     | '#+BEGIN_COMMENT' … '#+END_COMMENT'     |
| <e                     | '#+BEGIN_EXAMPLE' … '#+END_EXAMPLE'     |
| <E                     | '#+BEGIN_EXPORT' … '#+END_EXPORT'       |
| <h                     | '#+BEGIN_EXPORT html' … '#+END_EXPORT'  |
| <l                     | '#+BEGIN_EXPORT latex' … '#+END_EXPORT' |
| <q                     | '#+BEGIN_QUOTE' … '#+END_QUOTE'         |
| <s                     | '#+BEGIN_SRC' … '#+END_SRC'             |
| <v                     | '#+BEGIN_VERSE' … '#+END_VERSE'         |

#+begin_src emacs-lisp
(require 'org-tempo)
#+end_src

* Projectile

#+begin_src emacs-lisp
(use-package projectile
  :init
  (projectile-mode +1)
  :bind (:map projectile-mode-map
              ("C-c p" . projectile-command-map)))
#+end_src

* Visuals

** Smooth Scrolling

Not working :(

#+begin_src emacs-lisp
(pixel-scroll-mode -1)
(pixel-scroll-precision-mode 1)
#+end_src

** Beacon Mode

#+begin_src emacs-lisp
(use-package beacon
  :init
  (beacon-mode 1))
#+end_src

** Fonts

#+begin_src emacs-lisp
(set-face-attribute 'default nil
    :font "Lilex Nerd Font" 
    :height 150
    :weight 'medium)
(set-face-attribute 'fixed-pitch nil
    :family "Lilex Nerd Font Mono" 
    :height 150
    :weight 'medium)
(set-face-attribute 'variable-pitch nil
    :family "Lilex Nerd Font Propo" 
    :height 150
    :weight 'medium)
#+end_src

** Icons

#+begin_src emacs-lisp
(use-package nerd-icons)
#+end_src

** Mode Line

#+begin_src emacs-lisp
(use-package doom-modeline
  :init
  ;; (setq doom-modeline-height 35      ;; sets modeline height
  ;;       doom-modeline-bar-width 5    ;; sets right bar width
  ;;       doom-modeline-persp-name t   ;; adds perspective name to modeline
  ;;       doom-modeline-persp-icon t)  ;; adds folder icon next to persp name
  :config
  (doom-modeline-mode 1))

(use-package nyan-mode
  :init
  (setq nyan-animate-nyancat t)
  :config (nyan-mode 1))
#+end_src

** Rainbow Mode
Display the actual color as a background for any hex color value (ex. #BBFFBB).  The code block below enables rainbow-mode in all programming modes (prog-mode) as well as org-mode, which is why rainbow works in this document.

#+begin_src emacs-lisp
(use-package rainbow-mode
  :hook
  ((org-mode prog-mode) . rainbow-mode))
#+end_src

** Theme

#+begin_src emacs-lisp
  (use-package doom-themes
    :config
    (load-theme 'doom-challenger-deep t))
#+end_src

* Which Key

#+begin_src emacs-lisp
  (use-package which-key
    :straight t
    :init
    (which-key-mode 1)
    :config
    (setq which-key-side-window-location 'bottom
          which-key-sort-order #'which-key-key-order-alpha
          which-key-sort-uppercase-first nil
          which-key-add-column-padding 1
          which-key-max-display-columns nil
          which-key-min-display-lines 6
          which-key-side-window-slot -10
          which-key-side-window-max-height 0.25
          which-key-idle-delay 0.8
          which-key-max-description-length 25
          which-key-allow-imprecise-window-fit nil
          which-key-separator " -> " ))
#+end_src

* Uncategorized

#+begin_src emacs-lisp

(use-package el-patch)

;;; Remove GUI elements
(if (fboundp 'tool-bar-mode)   (tool-bar-mode -1))   ; Hide the outdated icons
(if (fboundp 'scroll-bar-mode) (scroll-bar-mode -1)) ; Hide the always visible scrollbar
(setq inhibit-splash-screen t)                       ; Remove the "Welcomde GNU Emacs" spalsh screen
(setq use-file-dialog nil)                           ; Ask for textual confirmation instead of GUI

(setq line-reminder-show-option 'indicators)

(setq-default indent-tabs-mode nil)
(setq-default tab-width 2)
(defalias 'yes-or-no-p 'y-or-n-p)
(setq initial-scratch-message nil)
(setq visible-bell t)

;;; Remove initial scratch message and "For information about GNU Emacs and the GNU system, type C-h C-a"
(defun display-startup-echo-area-message ()
  (message ""))

(delete-selection-mode 1)

;;; For Newbies like me
(cua-mode)

;;; Start maximised (cross-platf)
(add-hook 'window-setup-hook 'toggle-frame-maximized t)
(add-hook 'server-after-make-frame-hook 'toggle-frame-maximized t)

(set-charset-priority 'unicode)
(setq locale-coding-system 'utf-8
      coding-system-for-read 'utf-8
      coding-system-for-write 'utf-8)
(set-clipboard-coding-system 'utf-16-le)
(set-selection-coding-system 'utf-16-le)          ; correct
(set-terminal-coding-system 'utf-8)
(set-keyboard-coding-system 'utf-8)
(set-selection-coding-system 'utf-8)
(prefer-coding-system 'utf-8)
(setq default-process-coding-system '(utf-8-unix . utf-8-unix))

;;; Kill other buffers
(defun kill-other-buffers ()
  "Kill all other buffers."
  (interactive)
  (mapc #'(lambda (buf) (if (not (equal buf (current-buffer))) (kill-buffer buf))) (buffer-list)))

;;; Move-Text
(use-package move-text
  :init
  (move-text-default-bindings))

;;; Modes
(use-package markdown-mode
  :mode ("README\\.md\\'" . gfm-mode)
  :init (setq markdown-command "multimarkdown")
  :bind (:map markdown-mode-map
              ("C-c C-e" . markdown-do)))

(defun path-pp ()
  "Path Pretty Print: Display current PATH environment variable in a formatted temporary buffer."
  (interactive)
  (let* ((path-str (getenv "PATH"))
         (path-list (when path-str (split-string path-str path-separator)))
         (buf-name "*PATH*"))
    
    (if (not path-str)
        (message "PATH environment variable is not set")
      (with-current-buffer (get-buffer-create buf-name)
        (let ((inhibit-read-only t))  ; Temporarily disable read-only
          (erase-buffer)
          (insert "=== Current PATH Environment Variable ===\n\n")
          (insert (format "Total directories: %d\n\n" (length path-list)))
          
          (dolist (path-item path-list)
            (insert (format "%s;\n" path-item)))
          
          (insert "\n--- End of PATH ---\n")
          (goto-char (point-min))))
      
      (display-buffer buf-name))))

(defun transparent(alpha-level no-focus-alpha-level)
 "Let's you make the window transparent"
 (interactive "nAlpha level (0-100): \nnNo focus alpha level (0-100): ")
 (set-frame-parameter (selected-frame) 'alpha (list alpha-level no-focus-alpha-level))
 (add-to-list 'default-frame-alist `(alpha ,alpha-level)))

;; Should be at the end
(setq custom-file "~/.config/emacs/custom.el")
(load-file custom-file)

#+end_src
